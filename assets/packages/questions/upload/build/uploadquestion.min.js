!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function _createForOfIteratorHelper(e,t){var a;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,o=!0,s=!1;return{s:function(){a=e[Symbol.iterator]()},n:function(){var e=a.next();return o=e.done,e},e:function(e){s=!0,l=e},f:function(){try{o||null==a.return||a.return()}finally{if(s)throw l}}}}!function(){function addEvent(e,t,a){if(e.addEventListener)e.addEventListener(t,a,!1);else{if(!e.attachEvent)throw new Error("not supported or DOM not loaded");e.attachEvent("on"+t,(function(){a.call(e)}))}}if(document.documentElement.getBoundingClientRect)var getOffset=function(e){var t=e.getBoundingClientRect(),a=e.ownerDocument,n=a.body,i=a.documentElement,l=i.clientTop||n.clientTop||0,o=i.clientLeft||n.clientLeft||0,s=1;if(n.getBoundingClientRect){var r=n.getBoundingClientRect();s=(r.right-r.left)/n.clientWidth}return s>1&&(l=0,o=0),{top:t.top/s+(window.pageYOffset||i&&i.scrollTop/s||n.scrollTop/s)-l,left:t.left/s+(window.pageXOffset||i&&i.scrollLeft/s||n.scrollLeft/s)-o}};else var getOffset=function(e){var t=0,a=0;do{t+=e.offsetTop||0,a+=e.offsetLeft||0,e=e.offsetParent}while(e);return{left:a,top:t}};function getBox(e){var t,a,n=getOffset(e);return t=n.left,a=n.top,{left:t,right:t+e.offsetWidth,top:a,bottom:a+e.offsetHeight}}function addStyles(e,t){for(var a in t)t.hasOwnProperty(a)&&(e.style[a]=t[a])}function copyLayout(e,t){var a=getBox(e);addStyles(t,{position:"absolute",left:a.left+"px",top:a.top+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px"})}var toElement=(div=document.createElement("div"),function(e){div.innerHTML=e;var t=div.firstChild;return div.removeChild(t)}),div,getUID=(id=0,function(){return"ValumsAjaxUpload"+id++}),id;function fileFromPath(e){return e.replace(/.*(\/|\\)/,"")}function getExt(e){return-1!==(e=e.toLowerCase()).indexOf(".")?e.replace(/.*[.]/,""):""}function hasClass(e,t){return new RegExp("\\b"+t+"\\b").test(e.className)}function addClass(e,t){hasClass(e,t)||(e.className+=" "+t)}function removeClass(e,t){var a=new RegExp("\\b"+t+"\\b");e.className=e.className.replace(a,"")}function removeNode(e){e.parentNode.removeChild(e)}window.AjaxUpload=function(e,t){for(var a in this._settings={action:"upload.php",name:"userfile",multiple:!1,data:{},autoSubmit:!0,responseType:!1,hoverClass:"hover",focusClass:"focus",disabledClass:"disabled",onChange:function(e,t){},onSubmit:function(e,t){},onComplete:function(e,t){}},t)t.hasOwnProperty(a)&&(this._settings[a]=t[a]);if(e.jquery?e=e[0]:"string"==typeof e&&(/^#.*/.test(e)&&(e=e.slice(1)),e=document.getElementById(e)),!e||1!==e.nodeType)throw new Error("Please make sure that you're passing a valid element");"A"==e.nodeName.toUpperCase()&&addEvent(e,"click",(function(e){e&&e.preventDefault?e.preventDefault():window.event&&(window.event.returnValue=!1)})),this._button=e,this._input=null,this._disabled=!1,this.enable(),this._rerouteClicks()},AjaxUpload.prototype={setData:function(e){this._settings.data=e},disable:function(){addClass(this._button,this._settings.disabledClass),this._disabled=!0;var e=this._button.nodeName.toUpperCase();"INPUT"!=e&&"BUTTON"!=e||this._button.setAttribute("disabled","disabled"),this._input&&this._input.parentNode&&(this._input.parentNode.style.visibility="hidden")},enable:function(){removeClass(this._button,this._settings.disabledClass),this._button.removeAttribute("disabled"),this._disabled=!1},_createInput:function(){var e=this,t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("name",this._settings.name),this._settings.multiple&&t.setAttribute("multiple","multiple"),addStyles(t,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});var a=document.createElement("div");if(addStyles(a,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583}),"0"!==a.style.opacity){if(void 0===a.filters)throw new Error("Opacity not supported by the browser");a.style.filter="alpha(opacity=0)"}addEvent(t,"change",(function(){if(t&&""!==t.value){var a=fileFromPath(t.value);!1!==e._settings.onChange.call(e,a,getExt(a))?e._settings.autoSubmit&&e.submit():e._clearInput()}})),addEvent(t,"mouseover",(function(){addClass(e._button,e._settings.hoverClass)})),addEvent(t,"mouseout",(function(){removeClass(e._button,e._settings.hoverClass),removeClass(e._button,e._settings.focusClass),t.parentNode&&(t.parentNode.style.visibility="hidden")})),addEvent(t,"focus",(function(){addClass(e._button,e._settings.focusClass)})),addEvent(t,"blur",(function(){removeClass(e._button,e._settings.focusClass)})),a.appendChild(t),document.body.appendChild(a),this._input=t},_clearInput:function(){this._input&&(removeNode(this._input.parentNode),this._input=null,this._createInput(),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass))},_rerouteClicks:function(){var e=this;addEvent(e._button,"mouseover",(function(){if(!e._disabled){e._input||e._createInput();var t=e._input.parentNode;copyLayout(e._button,t),t.style.visibility="visible"}}))},_createIframe:function(){var e=getUID(),t=toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t},_createForm:function(e){var t=this._settings,a=toElement('<form method="post" enctype="multipart/form-data"></form>');for(var n in a.setAttribute("action",t.action),a.setAttribute("target",e.name),a.style.display="none",document.body.appendChild(a),t.data)if(t.data.hasOwnProperty(n)){var i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",n),i.setAttribute("value",t.data[n]),a.appendChild(i)}return a},_getResponse:function _getResponse(iframe,file){var toDeleteFlag=!1,self=this,settings=this._settings;addEvent(iframe,"load",(function(){if("javascript:'%3CHtml%3E%3C/html%3E';"!=iframe.src&&"javascript:'<html></html>';"!=iframe.src){var doc=iframe.contentDocument?iframe.contentDocument:window.frames[iframe.id].document,response;if(!doc.readyState||"complete"==doc.readyState)if(!doc.body||"false"!=doc.body.innerHTML)doc.XMLDocument?response=doc.XMLDocument:doc.body?(response=doc.body.innerHTML,settings.responseType&&"json"==settings.responseType.toLowerCase()&&(doc.body.firstChild&&"PRE"==doc.body.firstChild.nodeName.toUpperCase()&&(doc.normalize(),response=doc.body.firstChild.firstChild.nodeValue),response=response?eval("("+response+")"):{})):response=doc,settings.onComplete.call(self,file,response),toDeleteFlag=!0,iframe.src="javascript:'<html></html>';",removeNode(iframe)}else toDeleteFlag&&setTimeout((function(){removeNode(iframe)}),0)}))},submit:function(){var e=this._settings;if(this._input&&""!==this._input.value){var t=fileFromPath(this._input.value);if(!1!==e.onSubmit.call(this,t,getExt(t))){var a=this._createIframe();this._getResponse(a,t);var n=this._createForm(a);removeNode(this._input.parentNode),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass),n.appendChild(this._input),n.submit(),removeNode(n),n=null,removeNode(this._input),this._input=null,this._createInput()}else this._clearInput()}}}}(),window.uploadModalObjects=window.uploadModalObjects||{};var UploadQuestionController=function(){function e(t){_classCallCheck(this,e),this.fieldname=t,this.$el=$("#upload_"+t),this.$modalEl=$("#file-upload-modal-"+this.fieldname),this.show_title=this.$el.data("showtitle"),this.show_comment=this.$el.data("showcomment")}return _createClass(e,[{key:"prepareOpenUploadModalDialog",value:function(){var e=this;({})[uploadLang.returnTxt]=function(){e.$el.dialog("close")},$(document).off("shown.bs.modal.lsuploadquestion","#file-upload-modal-"+this.fieldname),$(document).on("shown.bs.modal.lsuploadquestion","#file-upload-modal-"+this.fieldname,(function(){var t=$("#uploader"+e.fieldname);t.load(t.data("src")),e.updateMaxHeightModalbody(e.$el)})),this.$modalEl.off("hide.bs.modal.lsuploadquestion"),this.$modalEl.on("hide.bs.modal.lsuploadquestion",(function(){var t=$("#uploader"+e.fieldname);return window.currentUploadHandler.saveAndExit(e.fieldname,e.show_title,e.show_comment,1),t.html(""),!0})),this.$el.off("click.lsuploadquestion"),this.$el.on("click.lsuploadquestion",(function(t){console.ls.log("File upload modal opening"),e.$modalEl.modal("show")}))}},{key:"updateUploadFrame",value:function(e,t){$("#"+e).innerHeight(t)}},{key:"updateMaxHeightModalbody",value:function(e){var t=$(e).find(".modal-header").outerHeight(),a=$(e).find(".modal-footer").outerHeight(),n=Math.max(150,$(window).height()-(t+a+16));console.ls.log([$(window).height(),t,a,t+a]),$(e).find(".modal-body").css("max-height",n)}},{key:"getQueryVariable",value:function(e,t){for(var a=t.split("/"),n=0;n<a.length;n++)if(a[n]==e)return a[n+1];for(var i=t.replace(/\&amp;/g,"&").split("&"),l=0;l<vars.length;l++){var o=i[l].split("=");if(o[0]==e)return o[1]}return null}},{key:"isValueInArray",value:function(e,t){inArray=!1;for(var a=0;a<e.length;a++)t.toLowerCase()==e[a].toLowerCase()&&(inArray=!0);return inArray}},{key:"displayUploadedFiles",value:function(e,t,a,n){var i=this,l=$("#"+t).val();if("[]"==l||""==l)return $("#"+this.fieldname+"_uploadedfiles").addClass("hidden"),void $("#"+this.fieldname+"_uploadedfiles").find("table>tbody").html("");if(""!==l){var o=[];try{o=JSON.parse(l)}catch(e){}$("#"+this.fieldname+"_uploadedfiles").removeClass("hidden"),$("#"+this.fieldname+"_uploadedfiles").find("table>tbody").html("");var s=new Array("gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico"),r=$("#filerowtemplate_"+this.fieldname).html();o.forEach((function(e,t){var l,o,d,u,p,c;i.isValueInArray(s,e.ext)?(l="image",o='<img src="'.concat(uploadurl,"/filegetcontents/").concat(decodeURIComponent(e.filename),'" class="uploaded" />')):(l="placeholder",o='<div class="upload-placeholder"></div>'),d=0!=a?e.title:"",u=0!=n?e.comment:"",p=e.name,c=t;var f=i.replaceWithObject(r,{imageOrPlaceholder:l,imageOrPlaceholderHtml:o,title:d,comment:u,name:p,filepointer:c});$("#"+i.fieldname+"_uploadedfiles").find("table>tbody").append(f)})),$(".trigger_edit_upload_"+this.fieldname).off("click.lsuploadquestion"),$(".trigger_edit_upload_"+this.fieldname).on("click.lsuploadquestion",(function(){i.$modalEl.modal("show")}))}}},{key:"replaceWithObject",value:function(e,t){var a=e;for(var n in t)a=a.replace(new RegExp("{".concat(n,"}")),t[n]);return a}},{key:"showBasic",value:function(){$("#basic").show()}},{key:"hideBasic",value:function(){$("#basic").hide()}}]),e}();window.UploadQuestionController=UploadQuestionController;var uploadHandler=function(e,t){var a=function(e,a,n){var i,l,s=n,r=new Array("gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico","heic"),d=$('<li id="'+e+"_li_"+s+'" class="previewblock file-element"></li>'),u=$('<div class="file-preview"></div>');if(i=r,l=a.ext.toLowerCase(),i.reduce((function(e,t){return e||l.toLowerCase()==t.toLowerCase()}),!1)?u.append('<img src="'+t.uploadurl+"/filegetcontents/"+a.filename+'" class="uploaded" />'):u.append('<div class="upload-placeholder"></div>'),u.append('<span class="file-name">'+escapeHtml(decodeURIComponent(a.name))+"</span>"),1==$("#"+e+"_show_title").val()||1==$("#"+e+"_show_comment").val()){var p=$(""),c=$("");if(1==$("#"+e+"_show_title").val()){p=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_title_"+s).text(t.uploadLang.titleFld).appendTo(p),$('<input class="form-control" type="text"/>').attr("id",e+"_title_"+s).val(a.title).wrap('<div class="input-container"></div>').appendTo(p)}if(1==$("#"+e+"_show_comment").val()){c=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_comment_"+s).text(t.uploadLang.commentFld).appendTo(c),$('<input class="form-control" type="text"/>').attr("id",e+"_comment_"+s).val(a.comment).wrap('<div class="input-container"></div>').appendTo(c)}}var f=$('<div class="form-group"></div>').append($('<a class="btn btn-danger"></a>').html('<span class="fa fa-trash"></span>&nbsp;'+t.uploadLang.deleteFile).on("click",(function(){o(e,s)})).wrap('<div class="input-container text-center"></div>'));$("<fieldset></fieldset>").append(p).append(c).append(f).wrap('<div class="file-info"></div>').appendTo(u),$('<input type="hidden" />').attr("id",e+"_size_"+s).attr("value",a.size).appendTo(d),$('<input type="hidden" />').attr("id",e+"_name_"+s).attr("value",a.name).appendTo(d),$('<input type="hidden" />').attr("id",e+"_file_index_"+s).attr("value",s).appendTo(d),$('<input type="hidden" />').attr("id",e+"_filename_"+s).attr("value",a.filename).appendTo(d),$('<input type="hidden" />').attr("id",e+"_ext_"+s).attr("value",a.ext).appendTo(d),0===$("#"+e+"_li_"+s).length&&(d.append(u),$("#field"+e+"_listfiles").append(d))},n=function(){var n=t.sFieldName,i=$("#"+n+"_filecount").val();if($("#"+n+"_filecount").val(i),i>0){var l=$("#"+n).val(),o="";try{o=JSON.parse(l)}catch(e){}0==$("#field"+n+"_listfiles").length&&$('<ul id="field'+n+'_listfiles" class="files-list" />').insertAfter("#uploadstatus_"+e),$("#"+n+"_licount").val(i),o.forEach((function(e,t){a(n,e,t+1)}))}var s=$("#button_"+e);new AjaxUpload(s,{action:t.uploadurl+"/sid/"+surveyid+"/preview/"+t.questgrppreview+"/fieldname/"+n+"/",name:"uploadfile",data:{valid_extensions:$("#"+n+"_allowed_filetypes").val(),max_filesize:$("#"+n+"_maxfilesize").val(),preview:$("#preview").val(),surveyid:surveyid,fieldname:n,YII_CSRF_TOKEN:t.csrfToken},onSubmit:function(e,a){var i=parseInt($("#"+n+"_maxfiles").val()),l=parseInt($("#"+n+"_filecount").val()),o=$("#"+n+"_allowed_filetypes").val().split(",");if(l>=i)return $("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorNoMoreFiles+"</p>"),!1;var r,d=!1,u=_createForOfIteratorHelper(o);try{for(u.s();!(r=u.n()).done;){var p=r.value;d=o.includes(p)}}catch(e){u.e(e)}finally{u.f()}if(0==d)return $("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorOnlyAllowed.replace("%s",$("#"+n+"_allowed_filetypes").val())+"</p>"),!1;s.text(t.uploadLang.uploading),this.disable(),s.append('<i id="loading-icon-fielupload" class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>')},onComplete:function(e,i){s.text(uploadLang.selectfile),$("#loading-icon-fielupload").remove(),this.enable();try{var l=JSON.parse(i)}catch(e){return void $("body").html(i)}var o=parseInt($("#"+n+"_licount").val());if(o++,$("#"+n+"_licount").val(o),l.success){$("#notice").html('<p class="alert alert-success"><span class="fa fa-success"></span>&nbsp;'+l.msg+"</p>"),0==$("#field"+n+"_listfiles").length&&$("<ul id='field"+n+"_listfiles' class='files-list' />").insertAfter("#uploadstatus_"+t.qid),a(n,l,o);var r=parseInt($("#"+n+"_filecount").val()),d=parseInt($("#"+n+"_minfiles").val());r++;var u=parseInt($("#"+n+"_maxfiles").val());$("#"+n+"_filecount").val(r),r<d?$("#uploadstatus").html(t.uploadLang.errorNeedMore.replace("%s",d-r)):r<u?$("#uploadstatus").html(t.uploadLang.errorMoreAllowed.replace("%s",u-r)):$("#uploadstatus").html(t.uploadLang.errorMaxReached),r>=u&&$("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+t.uploadLang.errorTooMuch+"</p>")}else $("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+l.msg+"</p>")}})};function i(e,t,a,n){for(var i=[],o=0,s=parseInt($("#"+e+"_licount").val()),r=1;r<=s;){if($("#"+e+"_li_"+r).is(":visible")){var d={title:1==$("#"+e+"_show_title").val()?$("#"+e+"_title_"+r).val():"",comment:1==$("#"+e+"_show_comment").val()?$("#"+e+"_comment_"+r).val():"",size:$("#"+e+"_size_"+r).val(),name:$("#"+e+"_name_"+r).val(),filename:$("#"+e+"_filename_"+r).val(),ext:$("#"+e+"_ext_"+r).val()};o+=1,i.push(d)}r++}$("#"+e).val(JSON.stringify(i)),l(o,e,t,a,n)}var l=function(e,t,a,n,i){$("#"+t+"_filecount").val(e),window["uploadQuestionController_"+t].displayUploadedFiles(e,t,a,n,i)},o=function(e,a){var n,i=$("#"+e+"_filename_"+a).val(),l=$("#"+e+"_name_"+a).val(),o=parseInt($("#"+e+"_filecount").val()),s=parseInt($("#"+e+"_licount").val());$.ajax({method:"POST",url:uploadurl,data:{delete:1,fieldname:e,filename:i,name:l,YII_CSRF_TOKEN:t.csrfToken}}).done((function(t){for($("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+t+"</p>"),setTimeout((function(){$(".success").remove()}),5e3),$("#"+e+"_li_"+a).hide(),o--,$("#"+e+"_filecount").val(o),n=$("#"+e+"_file_index_"+a).val(),j=a;j<=s;j++)$("#"+e+"_li_"+j).is(":visible")&&($("#"+e+"_file_index_"+j).val(n),n++);var i=parseInt($("#"+e+"_minfiles").val()),l=parseInt($("#"+e+"_maxfiles").val());o<i?$("#uploadstatus").html(uploadLang.errorNeedMore.replace("%s",i-o)):$("#uploadstatus").html(uploadLang.errorMoreAllowed.replace("%s",l-o))}))};return{init:function(){n()},saveAndExit:function(e,t,a,n){var l=parseInt($("#"+e+"_filecount").val()),o=parseInt($("#"+e+"_minfiles").val());return 0!=o&&l<o&&showpopups?!!confirm(uploadLang.errorNeedMoreConfirm.replace("%s",o-l))&&(i(e,t,a,n),!0):(i(e,t,a,n),!0)}}};function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}window.getUploadHandler=function(e,t){return window.currentUploadHandler=new uploadHandler(e,t),window.currentUploadHandler.init(),window.currentUploadHandler}}));
//# sourceMappingURL=uploadquestion.min.js.map
